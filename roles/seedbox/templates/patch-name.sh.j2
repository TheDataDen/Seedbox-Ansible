#!/bin/sh

CONFIG="/config/config.xml"
TARGET_NAME={{ target_name }}
DEFAULT_NAME={{ default_name }}

echo "[name-patch] Waiting for config.xml..."

for i in $(seq 1 30); do
  [ -f "$CONFIG" ] && break
  sleep 1
done

if [ ! -f "$CONFIG" ]; then
  echo "[name-patch] config.xml not found, skipping"
  exit 0
fi

CURRENT_NAME=$(sed -n 's|.*<InstanceName>\(.\+\)</InstanceName>.*|\1|p' "$CONFIG")

if [ "$CURRENT_NAME" = "$TARGET_NAME" ]; then
  echo "[name-patch] Name already set to $TARGET_NAME, nothing to do"
  exit 0
elif [ "$CURRENT_NAME" != "$DEFAULT_NAME" ]; then
  echo "[name-patch] Name is already different from default, nothing to do"
  exit 0
fi

echo "[name-patch] Patching name from $CURRENT_NAME to $TARGET_NAME..."
sed -i "s|<InstanceName>$CURRENT_NAME</InstanceName>|<InstanceName>$TARGET_NAME</InstanceName>|" "$CONFIG"

ehco "Container with be restarted by the failing healthcheck"